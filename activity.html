<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yufa Market Tracker / Activity</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-2">
            <div class="flex justify-between items-center">
                <div class="text-xl font-semibold text-gray-700">Yufa Market Tracker</div>
                <div class="flex space-x-4">
                    <a href="/" class="text-gray-600 hover:text-blue-500">Summary</a>
                    <a href="/full-list" class="text-gray-600 hover:text-blue-500">Full List</a>
                    <a href="/activity" class="text-blue-500 font-bold">Activity</a>
                    <a href="/players" class="text-gray-600 hover:text-blue-500">Player Count</a>
                    <a href="/characters" class="text-gray-600 hover:text-blue-500">Characters</a>
                    <a href="/guilds" class="text-gray-600 hover:text-blue-500">Guilds</a>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-3">
            <h1 class="text-2xl font-bold text-gray-800">Recent Market Activity</h1>
            <p class="text-sm text-gray-500">Last updated: <strong data-timestamp="{{.LastScrapeTime}}">{{.LastScrapeTime}}</strong> <span id="time-ago"></span></p>
        </div>

        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            {{if .MarketEvents}}
            <ul class="divide-y divide-gray-200">
                {{range .MarketEvents}}
                <li class="p-2 flex items-center space-x-3">
                    <span class="text-xs text-gray-500 w-24 flex-shrink-0 whitespace-nowrap">{{.Timestamp}}</span>
                    {{if eq .EventType "ADDED"}}
                        <span class="flex items-center gap-2 text-xs">
                            <span class="text-green-500">‚ûï</span>
                            <div class="flex flex-wrap items-center gap-x-2">
                                <div class="flex items-center font-semibold">
                                    <img src="https://static.divine-pride.net/images/items/item/{{.ItemID}}.png" alt="" class="w-5 h-5 mr-2" style="image-rendering: pixelated;">
                                    <a href="/item?name={{.ItemName | urlquery}}" class="hover:underline">{{.ItemName}}</a>
                                </div>
                                <span>was added for sale.</span>
                                <small class="text-gray-500">({{.Details.price}} zeny, Qty: {{printf "%.0f" .Details.quantity}} by {{.Details.seller}})</small>
                            </div>
                        </span>
                    {{else if eq .EventType "REMOVED"}}
                        <span class="flex items-center gap-2 text-xs text-gray-500">
                            <span>‚ûñ</span>
                            <div class="flex flex-wrap items-center gap-x-2">
                                <div class="flex items-center font-semibold text-gray-800">
                                    <img src="https://static.divine-pride.net/images/items/item/{{.ItemID}}.png" alt="" class="w-5 h-5 mr-2" style="image-rendering: pixelated;">
                                    <a href="/item?name={{.ItemName | urlquery}}" class="hover:underline">{{.ItemName}}</a>
                                </div>
                                <span>is no longer for sale.</span>
                            </div>
                        </span>
                    {{else if eq .EventType "NEW_LOW"}}
                         <span class="flex items-center gap-2 text-xs">
                            <span>üèÜ</span>
                            <div class="flex flex-wrap items-center gap-x-2">
                                <span class="bg-yellow-100 text-yellow-800 font-bold px-2 py-0.5 rounded-md">New historical low</span>
                                <span>for</span>
                                <div class="flex items-center font-semibold">
                                    <img src="https://static.divine-pride.net/images/items/item/{{.ItemID}}.png" alt="" class="w-5 h-5 mr-2" style="image-rendering: pixelated;">
                                    <a href="/item?name={{.ItemName | urlquery}}" class="hover:underline">{{.ItemName}}</a>!
                                </div>
                                <small class="text-gray-500">({{.Details.price}} zeny, Qty: {{printf "%.0f" .Details.quantity}} by {{.Details.seller}})</small>
                            </div>
                        </span>
                    {{end}}
                </li>
                {{end}}
            </ul>
            {{else}}
            <p class="text-center py-10 text-gray-500">No market activity has been recorded yet.</p>
            {{end}}
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const timeAgoSpan = document.getElementById('time-ago');
            const lastUpdateElement = document.querySelector('[data-timestamp]');
            if (!lastUpdateElement) return;
            const timestampStr = lastUpdateElement.dataset.timestamp;
            if (!timestampStr || timestampStr === 'Never') {
                timeAgoSpan.textContent = '(never updated)';
                return;
            }
            const lastUpdateDate = new Date(timestampStr);

            function updateTimeAgo() {
                const now = new Date();
                const secondsPast = Math.floor((now.getTime() - lastUpdateDate.getTime()) / 1000);
                if (secondsPast < 60) {
                    timeAgoSpan.textContent = `(${secondsPast} second${secondsPast !== 1 ? 's' : ''} ago)`;
                } else if (secondsPast < 3600) {
                    const minutes = Math.floor(secondsPast / 60);
                    timeAgoSpan.textContent = `(${minutes} minute${minutes !== 1 ? 's' : ''} ago)`;
                } else if (secondsPast < 86400) {
                    const hours = Math.floor(secondsPast / 3600);
                    timeAgoSpan.textContent = `(${hours} hour${hours !== 1 ? 's' : ''} ago)`;
                } else {
                    const days = Math.floor(secondsPast / 86400);
                    timeAgoSpan.textContent = `(${days} day${days !== 1 ? 's' : ''} ago)`;
                }
            }
            updateTimeAgo();
            setInterval(updateTimeAgo, 30000);
        });
    </script>
</body>
</html>
