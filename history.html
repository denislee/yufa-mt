<!DOCTYPE html>
<html lang="{{.Page.Lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Data.ItemName}} - Yufa Market Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        html { font-size: 100%; }
        .container {
            max-width: 95% !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 text-sm sm:text-base">

    {{template "navbar.html" .}}

    <div class="container mx-auto px-4 py-6">

        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 mb-4 border-b border-gray-200 pb-3">
            <div class="flex items-center gap-4">
                {{if .Data.ItemDetails}}
                <img src="{{.Data.ItemDetails.ImageURL}}" alt="{{.Data.ItemDetails.Name}}" class="h-16 w-16 bg-gray-200 p-1 rounded-md" style="image-rendering: pixelated;">
                {{else}}
                <div class="h-16 w-16 bg-gray-200 p-1 rounded-md flex items-center justify-center">
                    <svg class="w-8 h-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                    </svg>
                </div>
                {{end}}
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        {{.Page.T.price_history_for}}
                        {{if and (eq .Page.Lang "pt") .Data.ItemNamePT.Valid}}
                            {{.Data.ItemNamePT.String}}
                        {{else}}
                            {{.Data.ItemName}}
                        {{end}}
                    </h1>
                    {{if and (eq .Page.Lang "pt") .Data.ItemNamePT.Valid}}
                        <p class="text-lg text-gray-600">{{.Data.ItemName}}</p>
                    {{else if .Data.ItemNamePT.Valid}}
                        <p class="text-lg text-gray-600">{{.Data.ItemNamePT.String}}</p>
                    {{end}}
                </div>
            </div>
            <div id="last-updated" class="text-sm text-gray-500" data-timestamp="{{.Data.LastScrapeTime}}"></div>
        </div>

        {{if .Data.ItemDetails}}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="md:col-span-2 space-y-6">
                
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">{{.Page.T.item_details}}</h3>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4 text-sm">
                        <div>
                            <span class="block text-xs font-medium text-gray-500">{{.Page.T.type}}</span>
                            <span class="text-gray-800 font-medium">{{if .Data.ItemDetails.Type}}{{.Data.ItemDetails.Type}}{{else}}N/A{{end}}</span>
                        </div>
                        <div>
                            <span class="block text-xs font-medium text-gray-500">{{.Page.T.weight}}</span>
                            <span class="text-gray-800 font-medium">{{if .Data.ItemDetails.Weight}}{{.Data.ItemDetails.Weight}}{{else}}N/A{{end}}</span>
                        </div>
                        <div>
                            <span class="block text-xs font-medium text-gray-500">{{.Page.T.slots}}</span>
                            <span class="text-gray-800 font-medium">{{.Data.ItemDetails.Slots}}</span>
                        </div>
                        <div>
                            <span class="block text-xs font-medium text-gray-500">{{.Page.T.buy_sell}}</span>
                            <span class="text-gray-800 font-medium">{{if .Data.ItemDetails.Buy}}{{.Data.ItemDetails.Buy}}{{else}}N/A{{end}} / {{if .Data.ItemDetails.Sell}}{{.Data.ItemDetails.Sell}}{{else}}N/A{{end}}</span>
                        </div>
                    </div>

                    {{if .Data.ItemDetails.Script}}
                    <div>
                        <h3 class="font-medium text-gray-500">{{.Page.T.item_script}}</h3>
                        <pre class="mt-2 bg-gray-800 text-white text-xs rounded-md p-3 overflow-auto max-h-48 font-mono">{{.Data.ItemDetails.Script}}</pre>
                    </div>
                    {{end}}
                </div>

                <div class="bg-white p-4 rounded-lg shadow">
                    <canvas id="priceChart" data-price-json="{{.Data.PriceDataJSON}}" data-lowest-json="{{.Data.CurrentLowestJSON}}" data-highest-json="{{.Data.CurrentHighestJSON}}"></canvas>
                </div>
            </div>
            <div class="md:col-span-1 space-y-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium text-gray-500">{{.Page.T.all_time_price_range}}</h3>
                    <p class="text-lg font-mono">{{formatZeny .Data.OverallLowest}}z - {{formatZeny .Data.OverallHighest}}z</p>
                </div>
                {{if .Data.CurrentLowest}}
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium text-green-700">{{.Page.T.lowest_current_price}}</h3>
                    <p class="text-2xl font-bold font-mono text-green-700">{{formatZeny .Data.CurrentLowest.Price}} z</p>
                    <p class="text-sm text-gray-600"><strong class="font-medium">{{.Page.T.quantity}}</strong> {{.Data.CurrentLowest.Quantity}}</p>
                    <p class="text-sm text-gray-600"><strong class="font-medium">{{.Page.T.location}}</strong> <a href="/store?name={{.Data.CurrentLowest.StoreName | urlquery}}&seller={{.Data.CurrentLowest.SellerName | urlquery}}" class="italic hover:underline">{{.Data.CurrentLowest.StoreName}} ({{.Data.CurrentLowest.SellerName}})</a></p>
                    <p class="text-sm text-gray-600"><strong class="font-medium">{{.Page.T.date}}</strong> {{.Data.CurrentLowest.Timestamp}}</p>
                </div>
                {{end}}
                {{if .Data.CurrentHighest}}
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium text-red-700">{{.Page.T.highest_current_price}}</h3>
                    <p class="text-2xl font-bold font-mono text-red-700">{{formatZeny .Data.CurrentHighest.Price}} z</p>
                     <p class="text-sm text-gray-600"><strong class="font-medium">{{.Page.T.quantity}}</strong> {{.Data.CurrentHighest.Quantity}}</p>
                    <p class="text-sm text-gray-600"><strong class="font-medium">{{.Page.T.location}}</strong> <a href="/store?name={{.Data.CurrentHighest.StoreName | urlquery}}&seller={{.Data.CurrentHighest.SellerName | urlquery}}" class="italic hover:underline">{{.Data.CurrentHighest.StoreName}} ({{.Data.CurrentHighest.SellerName}})</a></p>
                    <p class="text-sm text-gray-600"><strong class="font-medium">{{.Page.T.date}}</strong> {{.Data.CurrentHighest.Timestamp}}</p>
                </div>
                {{end}}
                
                {{/* --- NEW: Item Drop History --- */}}
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-medium text-gray-700 mb-2 border-b pb-2">{{.Page.T.item_drop_history}}</h3>
                    <div class="overflow-x-auto max-h-48 overflow-y-auto">
                        <table class="min-w-full text-sm">
                            <tbody class="divide-y divide-gray-200">
                                {{range .Data.DropHistory}}
                                <tr class="hover:bg-gray-50">
                                    <td class="py-1.5 px-1 text-gray-500 whitespace-nowrap">{{.Timestamp}}</td>
                                    <td class="py-1.5 px-1 text-gray-700">
                                        <a href="/character?name={{.PlayerName | urlquery}}" class="font-semibold text-blue-600 hover:underline">{{.PlayerName}}</a>
                                    </td>
                                </tr>
                                {{else}}
                                <tr>
                                    <td colspan="2" class="py-4 text-center text-gray-500">{{.Page.T.no_item_drop_history}}</td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                </div>
                {{/* --- END NEW --- */}}
                
                </div>
            </div>
        {{else}}
        <div class="bg-white p-6 rounded-lg shadow text-center text-gray-500">
            <p>{{.Page.T.no_detailed_info}}</p>
        </div>
        {{end}}

        <div class="bg-white shadow-lg rounded-lg overflow-hidden mt-6">
            <h2 class="text-xl font-semibold p-4 border-b border-gray-200">{{.Page.T.all_recorded_listings}} <span class="text-base font-normal text-gray-500">{{printf .Page.T.total_listings .Data.TotalListings}}</span></h2>
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.price}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.qty}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.store}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.seller}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.location_coords}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.date_scanned}}</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-xs">
                        {{range .Data.AllListings}}
                        <tr class="border-b border-gray-200 hover:bg-gray-50 {{if not .IsAvailable}}opacity-60{{end}}" {{if not .IsAvailable}}title="{{$.Page.T.listing_not_available}}"{{end}}>
                            <td class="px-2 sm:px-3 py-2 font-semibold text-green-700">{{.Price}}</td>
                            <td class="px-2 sm:px-3 py-2">{{.Quantity}}</td>
                            <td class="px-2 sm:px-3 py-2">
                                <a href="/store?name={{.StoreName | urlquery}}&seller={{.SellerName | urlquery}}" class="font-semibold hover:underline">{{.StoreName}}</a>
                            </td>
                            <td class="px-2 sm:px-3 py-2">
                                <a href="/character?name={{.SellerName | urlquery}}" class="hover:underline">{{.SellerName}}</a>
                            </td>
                            <td class="px-2 sm:px-3 py-2">
                                {{.MapName}} <span class="text-gray-500">{{.MapCoordinates}}</span>
                            </td>
                            <td class="px-2 sm:px-3 py-2 whitespace-nowrap">{{.Timestamp}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>

        {{if gt .Data.Pagination.TotalPages 1}}
            {{$filter := .Data.Filter}}
            {{template "pagination" (dict "Page" .Page "Pagination" .Data.Pagination "Filter" $filter)}}
        {{end}}

    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const lang = document.documentElement.lang || 'en';
            const translations = {
                updated_never: '{{.Page.T.updated_never}}',
                updated_ago: '{{.Page.T.updated_ago}}',
                last_updated_at_hist: '{{.Page.T.last_updated_at_hist}}',
                js_lowest_price: '{{.Page.T.js_lowest_price}}',
                js_highest_price: '{{.Page.T.js_highest_price}}'
            };

            const lastUpdateElement = document.getElementById('last-updated');
            if (lastUpdateElement) {
                const timestampStr = lastUpdateElement.dataset.timestamp;

                if (!timestampStr || timestampStr === 'Never' || timestampStr === '') {
                    lastUpdateElement.textContent = translations.updated_never;
                    return;
                }

                const lastUpdateDate = new Date(timestampStr);
                const formattedTimestamp = lastUpdateDate.toLocaleString([], {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });

                const updateTimeAgo = () => {
                    const now = new Date();
                    const secondsPast = Math.floor((now.getTime() - lastUpdateDate.getTime()) / 1000);
                    let timeAgoString;

                    if (lang === 'pt') {
                        if (secondsPast < 5) timeAgoString = 'agora mesmo';
                        else if (secondsPast < 60) timeAgoString = `${secondsPast}s`;
                        else if (secondsPast < 3600) timeAgoString = `${Math.floor(secondsPast / 60)}m`;
                        else if (secondsPast < 86400) timeAgoString = `${Math.floor(secondsPast / 3600)}h`;
                        else timeAgoString = `${Math.floor(secondsPast / 86400)}d`;
                    } else {
                        if (secondsPast < 5) timeAgoString = 'just now';
                        else if (secondsPast < 60) timeAgoString = `${secondsPast}s ago`;
                        else if (secondsPast < 3600) timeAgoString = `${Math.floor(secondsPast / 60)}m ago`;
                        else if (secondsPast < 86400) timeAgoString = `${Math.floor(secondsPast / 3600)}h ago`;
                        else timeAgoString = `${Math.floor(secondsPast / 86400)}d ago`;
                    }
                    
                    // Replace first '%s' with the time ago string
                    let fullString = translations.last_updated_at_hist.replace('%s', timeAgoString);
                    
                    // Remove the second '%s' placeholder (which is the bug)
                    fullString = fullString.replace('%s', '').trim(); 
                    
                    // Append the timestamp like before
                    lastUpdateElement.innerHTML = `${fullString} <span class="text-gray-400 font-normal">(${formattedTimestamp})</span>`;
                };

                updateTimeAgo();
                setInterval(updateTimeAgo, 30000);
            }

            // Price Chart
            const chartCanvas = document.getElementById('priceChart');
            if (chartCanvas) {
                try {
                    const priceData = JSON.parse(chartCanvas.dataset.priceJson || '[]');
                    const currentLowest = JSON.parse(chartCanvas.dataset.lowestJson || 'null');
                    const currentHighest = JSON.parse(chartCanvas.dataset.highestJson || 'null');

                    if (priceData.length > 0) {
                        const lowestPriceData = priceData.map(p => ({ x: new Date(p.Timestamp), y: p.LowestPrice, ...p }));
                        const highestPriceData = priceData.map(p => ({ x: new Date(p.Timestamp), y: p.HighestPrice, ...p }));
                        
                        if (currentLowest) {
                            const lastDataPoint = lowestPriceData[lowestPriceData.length - 1];
                            const lastTime = lastDataPoint.x.getTime();
                            const now = new Date().getTime();
                            
                            if (now - lastTime > 60000) { 
                                lowestPriceData.push({ x: new Date(), y: currentLowest.Price });
                                highestPriceData.push({ x: new Date(), y: currentHighest.Price });
                            }
                        }

                        const ctx = chartCanvas.getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: [{
                                    label: translations.js_lowest_price,
                                    data: lowestPriceData,
                                    borderColor: 'rgba(22, 163, 74, 1)',
                                    backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                    borderWidth: 2,
                                    fill: false,
                                    tension: 0.1,
                                    pointRadius: 2,
                                    pointHoverRadius: 5
                                }, {
                                    label: translations.js_highest_price,
                                    data: highestPriceData,
                                    borderColor: 'rgba(220, 38, 38, 1)',
                                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                    borderWidth: 2,
                                    fill: false,
                                    tension: 0.1,
                                    pointRadius: 2,
                                    pointHoverRadius: 5
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                scales: {
                                    y: {
                                        ticks: {
                                            callback: function(value, index, values) {
                                                if (value >= 1000000) return (value / 1000000) + 'm';
                                                if (value >= 1000) return (value / 1000) + 'k';
                                                return value;
                                            }
                                        }
                                    },
                                    x: {
                                        type: 'time',
                                        time: {
                                            unit: 'day',
                                            tooltipFormat: 'yyyy-MM-dd HH:mm',
                                            displayFormats: {
                                                hour: 'HH:mm',
                                                day: 'MMM d'
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false,
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed.y !== null) {
                                                    label += new Intl.NumberFormat('en-US').format(context.parsed.y) + 'z';
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (e) {
                    console.error('Failed to parse price chart data:', e);
                }
            }
        });
    </script>
</body>
</html>
