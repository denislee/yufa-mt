<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price History for {{.ItemName}}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        a { color: #007bff; }
        .info-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .card {
            flex: 1;
            min-width: 300px;
            background: #fdfdfd;
            border: 1px solid #e1e4e8;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        .card h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            font-size: 1.2em;
            color: #333;
        }
        .card p {
            margin: 8px 0;
            font-size: 0.95em;
        }
        .card strong {
            color: #555;
            display: inline-block;
            width: 80px;
        }
        #min-price-card h2 { color: #28a745; }
        #max-price-card h2 { color: #dc3545; }
        .overall-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            text-align: center;
        }
        .overall-summary p {
            margin: 0;
            font-size: 1.1em;
            color: #495057;
        }
        .overall-summary strong {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/">&larr; Back to Market List</a>
        <h1>Price History for: <strong>{{.ItemName}}</strong></h1>

        <div class="overall-summary">
            <p>
                All-Time Price Range: 
                <strong id="overall-min-display" style="color: #28a745;">N/A</strong> &mdash; 
                <strong id="overall-max-display" style="color: #dc3545;">N/A</strong>
            </p>
        </div>

        <div class="info-cards">
            <div class="card" id="min-price-card">
                <h2>Lowest Price</h2>
                <p><strong>Price:</strong> <span id="min-price-val"></span></p>
                <p><strong>Quantity:</strong> <span id="min-quantity-val"></span></p>
                <p><strong>Store:</strong> <span id="min-store-val"></span></p>
                <p><strong>Seller:</strong> <span id="min-seller-val"></span></p>
                <p><strong>Location:</strong> <span id="min-location-val"></span></p>
                <p><strong>Date:</strong> <span id="min-date-val"></span></p>
            </div>
            <div class="card" id="max-price-card">
                <h2>Highest Price</h2>
                <p><strong>Price:</strong> <span id="max-price-val"></span></p>
                <p><strong>Quantity:</strong> <span id="max-quantity-val"></span></p>
                <p><strong>Store:</strong> <span id="max-store-val"></span></p>
                <p><strong>Seller:</strong> <span id="max-seller-val"></span></p>
                <p><strong>Location:</strong> <span id="max-location-val"></span></p>
                <p><strong>Date:</strong> <span id="max-date-val"></span></p>
            </div>
        </div>

        <canvas id="priceChart"></canvas>
    </div>

    <script>
        // Go's template engine will safely inject the JSON data here
        const priceHistoryData = {{.PriceDataJSON}};

        // ADDED: Populate All-Time Summary
        const overallMin = {{.OverallMin}};
        const overallMax = {{.OverallMax}};

        if (overallMin > 0) {
            document.getElementById('overall-min-display').textContent = `${overallMin.toLocaleString()}z`;
        }
        if (overallMax > 0) {
            document.getElementById('overall-max-display').textContent = `${overallMax.toLocaleString()}z`;
        }

        // --- ADDED: Populate Info Cards ---
        if (priceHistoryData && priceHistoryData.length > 0) {
            // Find the data point with the overall lowest min price
            const overallMinPriceData = priceHistoryData.reduce((prev, current) => {
                return (prev.MinPrice < current.MinPrice) ? prev : current;
            });

            // Find the data point with the overall highest max price
            const overallMaxPriceData = priceHistoryData.reduce((prev, current) => {
                return (prev.MaxPrice > current.MaxPrice) ? prev : current;
            });

            // Populate the Min Price Card
            document.getElementById('min-price-val').textContent = `${overallMinPriceData.MinPrice.toLocaleString()}z`;
            document.getElementById('min-quantity-val').textContent = overallMinPriceData.MinQuantity.toLocaleString();
            document.getElementById('min-store-val').textContent = overallMinPriceData.MinStoreName;
            document.getElementById('min-seller-val').textContent = overallMinPriceData.MinSellerName;
            document.getElementById('min-location-val').textContent = `${overallMinPriceData.MinMapName} (${overallMinPriceData.MinMapCoords})`;
            document.getElementById('min-date-val').textContent = overallMinPriceData.Timestamp;

            // Populate the Max Price Card
            document.getElementById('max-price-val').textContent = `${overallMaxPriceData.MaxPrice.toLocaleString()}z`;
            document.getElementById('max-quantity-val').textContent = overallMaxPriceData.MaxQuantity.toLocaleString();
            document.getElementById('max-store-val').textContent = overallMaxPriceData.MaxStoreName;
            document.getElementById('max-seller-val').textContent = overallMaxPriceData.MaxSellerName;
            document.getElementById('max-location-val').textContent = `${overallMaxPriceData.MaxMapName} (${overallMaxPriceData.MaxMapCoords})`;
            document.getElementById('max-date-val').textContent = overallMaxPriceData.Timestamp;
        }
        // --- END: Populate Info Cards ---


        // Prepare data for Chart.js
        const labels = priceHistoryData.map(p => p.Timestamp);
        // CHANGED: The data source for prices is now more specific (e.g., p.MinPrice).
        const minPrices = priceHistoryData.map(p => p.MinPrice);
        const maxPrices = priceHistoryData.map(p => p.MaxPrice);

        const ctx = document.getElementById('priceChart').getContext('2d');
        const priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Minimum Price',
                        data: minPrices,
                        borderColor: 'rgba(40, 167, 69, 1)',
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Maximum Price',
                        data: maxPrices,
                        borderColor: 'rgba(220, 53, 69, 1)',
                        backgroundColor: 'rgba(220, 53, 69, 0.2)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }
                ]
            },
            // CHANGED: Added a detailed tooltip configuration.
            options: {
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value, index, values) {
                                return value.toLocaleString() + 'z'; // Format Y-axis with 'z'
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            // The 'afterLabel' callback adds extra lines of text to the tooltip.
                            afterLabel: function(context) {
                                const dataPoint = priceHistoryData[context.dataIndex];
                                if (!dataPoint) return '';

                                let details = [];
                                // Check which dataset (Min or Max price) the user is hovering over
                                // and display the corresponding details.
                                if (context.dataset.label === 'Minimum Price') {
                                    details.push(`  Quantity: ${dataPoint.MinQuantity.toLocaleString()}`);
                                    details.push(`  Store: ${dataPoint.MinStoreName}`);
                                    details.push(`  Seller: ${dataPoint.MinSellerName}`);
                                    details.push(`  Map: ${dataPoint.MinMapName} (${dataPoint.MinMapCoords})`);
                                } else if (context.dataset.label === 'Maximum Price') {
                                    details.push(`  Quantity: ${dataPoint.MaxQuantity.toLocaleString()}`);
                                    details.push(`  Store: ${dataPoint.MaxStoreName}`);
                                    details.push(`  Seller: ${dataPoint.MaxSellerName}`);
                                    details.push(`  Map: ${dataPoint.MaxMapName} (${dataPoint.MaxMapCoords})`);
                                }
                                // The returned array of strings will be rendered as new lines.
                                return details;
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
