<!DOCTYPE html>
<html lang="{{.Page.Lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Page.T.woe_rankings_title}} - Yufa Market Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { font-size: 100%; }
        .container {
            max-width: 95% !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 text-sm sm:text-base">

    {{template "navbar.html" .}}

    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 mb-4 border-b border-gray-200 pb-3">
            <h1 class="text-2xl font-bold text-gray-800">{{.Page.T.woe_rankings_title}}</h1>
            <!-- NEW: Show selected event date instead of last scrape time -->
            {{if .Data.SelectedEventDate}}
                <div id="last-updated" class="text-sm text-gray-500">
                    {{printf .Page.T.info_loaded_at .Data.SelectedEventDate}}
                </div>
            {{end}}
        </div>

        <div class="mb-4">
            <div class="sm:hidden">
                <label for="tabs" class="sr-only">Select a tab</label>
                <!-- NEW: Added season_id and event_id to tab links -->
                <select id="tabs" name="tabs" onchange="window.location.href = this.value;" class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                    <option value="/woe?tab=characters&season_id={{.Data.SelectedSeasonID}}&event_id={{.Data.SelectedEventID}}" {{if eq .Data.ActiveTab "characters"}}selected{{end}}>{{.Page.T.char_rankings}}</option>
                    <option value="/woe?tab=guilds&season_id={{.Data.SelectedSeasonID}}&event_id={{.Data.SelectedEventID}}" {{if eq .Data.ActiveTab "guilds"}}selected{{end}}>{{.Page.T.guild_rankings}}</option>
                    <option value="/woe?tab=guilds_by_class&season_id={{.Data.SelectedSeasonID}}&event_id={{.Data.SelectedEventID}}" {{if eq .Data.ActiveTab "guilds_by_class"}}selected{{end}}>{{.Page.T.nav_woe_guild_by_class}}</option>
                </select>
            </div>
            <div class="hidden sm:block">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <!-- NEW: Added season_id and event_id to tab links -->
                        <a href="/woe?tab=characters&season_id={{.Data.SelectedSeasonID}}&event_id={{.Data.SelectedEventID}}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{if eq .Data.ActiveTab "characters"}}border-blue-500 text-blue-600{{else}}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{end}}">
                            {{.Page.T.char_rankings}}
                        </a>
                        <a href="/woe?tab=guilds&season_id={{.Data.SelectedSeasonID}}&event_id={{.Data.SelectedEventID}}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{if eq .Data.ActiveTab "guilds"}}border-blue-500 text-blue-600{{else}}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{end}}">
                            {{.Page.T.guild_rankings}}
                        </a>
                        <a href="/woe?tab=guilds_by_class&season_id={{.Data.SelectedSeasonID}}&event_id={{.Data.SelectedEventID}}" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{if eq .Data.ActiveTab "guilds_by_class"}}border-blue-500 text-blue-600{{else}}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{end}}">
                            {{.Page.T.nav_woe_guild_by_class}}
                        </a>
                        </nav>
                </div>
            </div>
        </div>

        <div class="bg-white p-3 rounded-lg shadow mb-4">
            <form action="/woe" method="GET" id="woe-filter-form" class="flex flex-wrap items-end gap-3">
                <input type="hidden" name="tab" value="{{.Data.ActiveTab}}">
                
                <!-- NEW: Season Selector -->
                <div class="flex-grow min-w-[150px]">
                    <label for="season_id" class="block text-xs font-medium text-gray-700">Season</label>
                    <select name="season_id" id="season_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-sm">
                        {{range .Data.AllSeasons}}
                            <option value="{{.SeasonID}}" {{if eq .SeasonID $.Data.SelectedSeasonID}}selected{{end}}>
                                Season {{.SeasonID}} ({{.StartDate}})
                            </option>
                        {{end}}
                    </select>
                </div>

                <!-- NEW: Event Selector -->
                <div class="flex-grow min-w-[150px]">
                    <label for="event_id" class="block text-xs font-medium text-gray-700">Event</label>
                    <select name="event_id" id="event_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-sm" {{if not .Data.EventsForSeason}}disabled{{end}}>
                        {{if .Data.EventsForSeason}}
                            {{range .Data.EventsForSeason}}
                                <option value="{{.EventID}}" {{if eq .EventID $.Data.SelectedEventID}}selected{{end}}>
                                    {{.EventDate}}
                                </option>
                            {{end}}
                        {{else}}
                            <option value="">No events for this season</option>
                        {{end}}
                    </select>
                </div>

                <div class="flex-grow min-w-[150px]">
                    <label for="name_query" class="block text-xs font-medium text-gray-700">
                        {{if eq .Data.ActiveTab "characters"}}
                            {{.Page.T.search_by_char}}
                        {{else}}
                            {{.Page.T.search_by_guild}}
                        {{end}}
                    </label>
                    <input type="text" name="query" id="name_query" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-sm" value="{{.Data.SearchQuery}}">
                </div>
                
                {{if or (eq .Data.ActiveTab "characters") (eq .Data.ActiveTab "guilds_by_class")}}
                <div class="flex-grow min-w-[150px]">
                    <label for="class_filter" class="block text-xs font-medium text-gray-700">{{.Page.T.filter_by_class}}</label>
                    <select name="class_filter" id="class_filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-sm">
                        <option value="">{{.Page.T.all_classes}}</option>
                        {{range .Data.AllClasses}}
                            <option value="{{.}}" {{if eq . $.Data.SelectedClass}}selected{{end}}>{{.}}</option>
                        {{end}}
                    </select>
                </div>
                {{end}}

                <button type="submit" class="w-full md:w-auto bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">{{.Page.T.search}}</button>
            </form>
        </div>

        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                
                {{if eq .Data.ActiveTab "characters"}}
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            {{$filter := .Data.Filter}}
                            {{$currentSort := .Data.SortBy}}
                            {{$currentOrder := .Data.Order}}
                            {{$revOrder := "ASC"}}{{if eq $currentOrder "ASC"}}{{$revOrder = "DESC"}}{{end}}

                            <!-- NEW: Sorting links now include all filters -->
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=name&order={{if eq $currentSort "name"}}{{$revOrder}}{{else}}ASC{{end}}{{$filter}}">{{.Page.T.character}} {{if eq $currentSort "name"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=class&order={{if eq $currentSort "class"}}{{$revOrder}}{{else}}ASC{{end}}{{$filter}}">{{.Page.T.class}} {{if eq $currentSort "class"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=guild&order={{if eq $currentSort "guild"}}{{$revOrder}}{{else}}ASC{{end}}{{$filter}}">{{.Page.T.guild}} {{if eq $currentSort "guild"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=kills&order={{if eq $currentSort "kills"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.kills}} {{if eq $currentSort "kills"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=deaths&order={{if eq $currentSort "deaths"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.deaths}} {{if eq $currentSort "deaths"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=damage&order={{if eq $currentSort "damage"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.damage}} {{if eq $currentSort "damage"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=healing&order={{if eq $currentSort "healing"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.healing}} {{if eq $currentSort "healing"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=emperium&order={{if eq $currentSort "emperium"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.emperium}} {{if eq $currentSort "emperium"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=points&order={{if eq $currentSort "points"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.points}} {{if eq $currentSort "points"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-xs">
                        {{range .Data.Characters}}
                         <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="px-2 sm:px-3 py-2">
                                <div class="flex items-center">
                                    <img src="{{.Class | getClassImageURL}}" alt="{{.Class}}" class="w-6 h-6 mr-2" style="image-rendering: pixelated;">
                                    <a href="/character?name={{.Name | urlquery}}" class="font-semibold hover:underline">{{.Name}}</a>
                                </div>
                            </td>
                            <td class="px-2 sm:px-3 py-2">
                                {{.Class}}
                            </td>
                            <td class="px-2 sm:px-3 py-2">
                                {{if .GuildName.Valid}}
                                <a href="/guild?name={{.GuildName.String | urlquery}}" class="font-normal hover:underline">{{.GuildName.String}}</a>
                                {{else}}
                                <span class="text-gray-400">N/A</span>
                                {{end}}
                            </td>
                            <td class="px-2 sm:px-3 py-2 font-semibold text-green-600">{{.KillCount}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold text-red-600">{{.DeathCount}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.DamageDone | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.HealingDone | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.EmperiumKill}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.Points}}</td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="9" class="px-3 py-4 text-center text-gray-500">{{.Page.T.no_chars_found}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                
                {{else if eq .Data.ActiveTab "guilds"}}
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            {{$filter := .Data.Filter}}
                            {{$currentSort := .Data.SortBy}}
                            {{$currentOrder := .Data.Order}}
                            {{$revOrder := "ASC"}}{{if eq $currentOrder "ASC"}}{{$revOrder = "DESC"}}{{end}}

                            <!-- NEW: Sorting links now include all filters -->
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=guild&order={{if eq $currentSort "guild"}}{{$revOrder}}{{else}}ASC{{end}}{{$filter}}">{{.Page.T.guild}} {{if eq $currentSort "guild"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=members&order={{if eq $currentSort "members"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.members}} {{if eq $currentSort "members"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=kills&order={{if eq $currentSort "kills"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.total_kills}} {{if eq $currentSort "kills"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=deaths&order={{if eq $currentSort "deaths"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.total_deaths}} {{if eq $currentSort "deaths"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=kd&order={{if eq $currentSort "kd"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.kd_ratio}} {{if eq $currentSort "kd"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=damage&order={{if eq $currentSort "damage"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.total_damage}} {{if eq $currentSort "damage"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=healing&order={{if eq $currentSort "healing"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.total_healing}} {{if eq $currentSort "healing"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=emperium&order={{if eq $currentSort "emperium"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.emperium}} {{if eq $currentSort "emperium"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=points&order={{if eq $currentSort "points"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.points}} {{if eq $currentSort "points"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-xs">
                        {{range .Data.Guilds}}
                         <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="px-2 sm:px-3 py-2">
                                {{if .GuildName.Valid}}
                                <a href="/guild?name={{.GuildName.String | urlquery}}" class="font-semibold hover:underline">{{.GuildName.String}}</a>
                                {{else}}
                                <span class="text-gray-400">N/A</span>
                                {{end}}
                            </td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.MemberCount}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold text-green-600">{{.TotalKills | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold text-red-600">{{.TotalDeaths | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.KillDeathRatio | formatAvgLevel}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalDamage | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalHealing | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalEmpKills | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalPoints | formatZeny}}</td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="9" class="px-3 py-4 text-center text-gray-500">{{.Page.T.no_guilds_found}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                
                {{else if eq .Data.ActiveTab "guilds_by_class"}}
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            {{$filter := .Data.Filter}}
                            {{$currentSort := .Data.SortBy}}
                            {{$currentOrder := .Data.Order}}
                            {{$revOrder := "ASC"}}{{if eq $currentOrder "ASC"}}{{$revOrder = "DESC"}}{{end}}

                            <!-- Note: Sorting not implemented for this view in the handler, but structure is here -->
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.class}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.members}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.total_kills}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.total_deaths}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.kd_ratio}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.total_damage}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.total_healing}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.emperium}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.points}}</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-xs">
                        {{if .Data.GuildClassRanksMap}}
                            {{range $guildName, $classes := .Data.GuildClassRanksMap}}
                                <tr class="bg-gray-100 font-semibold border-b-2 border-gray-300">
                                    <td colspan="9" class="px-2 sm:px-3 py-2 text-sm">
                                        <a href="/guild?name={{$guildName | urlquery}}" class="hover:underline">{{$guildName}}</a>
                                    </td>
                                </tr>
                                {{range $class := $classes}}
                                <tr class="border-b border-gray-200 hover:bg-gray-50">
                                    <td class="px-2 sm:px-3 py-2 pl-6"> <div class="flex items-center">
                                            <img src="{{.Class | getClassImageURL}}" alt="{{.Class}}" class="w-6 h-6 mr-2" style="image-rendering: pixelated;">
                                            {{.Class}}
                                        </div>
                                    </td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.MemberCount}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold text-green-600">{{.TotalKills | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold text-red-600">{{.TotalDeaths | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.KillDeathRatio | formatAvgLevel}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalDamage | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalHealing | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalEmpKills | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalPoints | formatZeny}}</td>
                                </tr>
                                {{end}}
                            {{end}}
                        {{else}}
                            <tr>
                                <td colspan="9" class="px-3 py-4 text-center text-gray-500">{{.Page.T.no_guilds_found}}</td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
                {{end}}

            </div>
        </div>
        
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // NEW: Form submission logic for season/event dropdowns
        const form = document.getElementById('woe-filter-form');
        const seasonSelect = document.getElementById('season_id');
        const eventSelect = document.getElementById('event_id');

        if (seasonSelect) {
            seasonSelect.addEventListener('change', () => {
                // When season changes, reset event_id and submit
                if (eventSelect) {
                    eventSelect.value = ""; 
                }
                form.submit();
            });
        }
        
        if (eventSelect) {
             eventSelect.addEventListener('change', () => {
                // When event changes, just submit
                form.submit();
            });
        }

        // --- OLD SCRIPT (Removed) ---
        // The timeago script is no longer needed as we display the event date directly.
    });
    </script>
</body>
</html>
