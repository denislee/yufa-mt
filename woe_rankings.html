<!DOCTYPE html>
<html lang="{{.Page.Lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Page.T.woe_rankings_title}} - Yufa Market Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { font-size: 100%; }
        .container {
            max-width: 95% !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 text-sm sm:text-base">

    {{template "navbar.html" .}}

    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 mb-4 border-b border-gray-200 pb-3">
            <h1 class="text-2xl font-bold text-gray-800">{{.Page.T.woe_rankings_title}}</h1>
            <div id="last-updated" class="text-sm text-gray-500" data-timestamp="{{.Data.LastScrapeTime}}"></div>
        </div>

        <div class="mb-4">
            <div class="sm:hidden">
                <label for="tabs" class="sr-only">Select a tab</label>
                <select id="tabs" name="tabs" onchange="window.location.href = this.value;" class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                    <option value="/woe?tab=characters" {{if eq .Data.ActiveTab "characters"}}selected{{end}}>{{.Page.T.char_rankings}}</option>
                    <option value="/woe?tab=guilds" {{if eq .Data.ActiveTab "guilds"}}selected{{end}}>{{.Page.T.guild_rankings}}</option>
                    <option value="/woe?tab=guilds_by_class" {{if eq .Data.ActiveTab "guilds_by_class"}}selected{{end}}>{{.Page.T.nav_woe_guild_by_class}}</option> </select>
            </div>
            <div class="hidden sm:block">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <a href="/woe?tab=characters" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{if eq .Data.ActiveTab "characters"}}border-blue-500 text-blue-600{{else}}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{end}}">
                            {{.Page.T.char_rankings}}
                        </a>
                        <a href="/woe?tab=guilds" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{if eq .Data.ActiveTab "guilds"}}border-blue-500 text-blue-600{{else}}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{end}}">
                            {{.Page.T.guild_rankings}}
                        </a>
                        <a href="/woe?tab=guilds_by_class" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm {{if eq .Data.ActiveTab "guilds_by_class"}}border-blue-500 text-blue-600{{else}}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{{end}}">
                            {{.Page.T.nav_woe_guild_by_class}}
                        </a>
                        </nav>
                </div>
            </div>
        </div>

        <div class="bg-white p-3 rounded-lg shadow mb-4">
            <form action="/woe" method="GET" class="flex flex-wrap items-end gap-3">
                <input type="hidden" name="tab" value="{{.Data.ActiveTab}}">
                
                <div class="flex-grow">
                    <label for="name_query" class="block text-xs font-medium text-gray-700">
                        {{if eq .Data.ActiveTab "characters"}}
                            {{.Page.T.search_by_char}}
                        {{else}}
                            {{.Page.T.search_by_guild}}
                        {{end}}
                    </label>
                    <input type="text" name="query" id="name_query" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-sm" value="{{.Data.SearchQuery}}">
                </div>
                
                {{if or (eq .Data.ActiveTab "characters") (eq .Data.ActiveTab "guilds_by_class")}}
                <div class="flex-grow">
                    <label for="class_filter" class="block text-xs font-medium text-gray-700">{{.Page.T.filter_by_class}}</label>
                    <select name="class_filter" id="class_filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-sm">
                        <option value="">{{.Page.T.all_classes}}</option>
                        {{range .Data.AllClasses}}
                            <option value="{{.}}" {{if eq . $.Data.SelectedClass}}selected{{end}}>{{.}}</option>
                        {{end}}
                    </select>
                </div>
                {{end}}

                <button type="submit" class="w-full md:w-auto bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">{{.Page.T.search}}</button>
            </form>
        </div>

        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                
                {{if eq .Data.ActiveTab "characters"}}
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            {{$filter := .Data.Filter}}
                            {{$currentSort := .Data.SortBy}}
                            {{$currentOrder := .Data.Order}}
                            {{$revOrder := "ASC"}}{{if eq $currentOrder "ASC"}}{{$revOrder = "DESC"}}{{end}}

                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=name&order={{if eq $currentSort "name"}}{{$revOrder}}{{else}}ASC{{end}}{{$filter}}">{{.Page.T.character}} {{if eq $currentSort "name"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=class&order={{if eq $currentSort "class"}}{{$revOrder}}{{else}}ASC{{end}}{{$filter}}">{{.Page.T.class}} {{if eq $currentSort "class"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=guild&order={{if eq $currentSort "guild"}}{{$revOrder}}{{else}}ASC{{end}}{{$filter}}">{{.Page.T.guild}} {{if eq $currentSort "guild"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=kills&order={{if eq $currentSort "kills"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.kills}} {{if eq $currentSort "kills"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=deaths&order={{if eq $currentSort "deaths"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.deaths}} {{if eq $currentSort "deaths"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=damage&order={{if eq $currentSort "damage"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.damage}} {{if eq $currentSort "damage"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=healing&order={{if eq $currentSort "healing"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.healing}} {{if eq $currentSort "healing"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=emperium&order={{if eq $currentSort "emperium"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.emperium}} {{if eq $currentSort "emperium"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=points&order={{if eq $currentSort "points"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.points}} {{if eq $currentSort "points"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-xs">
                        {{range .Data.Characters}}
                         <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="px-2 sm:px-3 py-2">
                                <div class="flex items-center">
                                    <img src="{{.Class | getClassImageURL}}" alt="{{.Class}}" class="w-6 h-6 mr-2" style="image-rendering: pixelated;">
                                    <a href="/character?name={{.Name | urlquery}}" class="font-semibold hover:underline">{{.Name}}</a>
                                </div>
                            </td>
                            <td class="px-2 sm:px-3 py-2">
                                {{.Class}}
                            </td>
                            <td class="px-2 sm:px-3 py-2">
                                {{if .GuildName.Valid}}
                                <a href="/guild?name={{.GuildName.String | urlquery}}" class="font-normal hover:underline">{{.GuildName.String}}</a>
                                {{else}}
                                <span class="text-gray-400">N/A</span>
                                {{end}}
                            </td>
                            <td class="px-2 sm:px-3 py-2 font-semibold text-green-600">{{.KillCount}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold text-red-600">{{.DeathCount}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.DamageDone | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.HealingDone | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.EmperiumKill}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.Points}}</td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="9" class="px-3 py-4 text-center text-gray-500">{{.Page.T.no_chars_found}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                
                {{else if eq .Data.ActiveTab "guilds"}}
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            {{$filter := .Data.Filter}}
                            {{$currentSort := .Data.SortBy}}
                            {{$currentOrder := .Data.Order}}
                            {{$revOrder := "ASC"}}{{if eq $currentOrder "ASC"}}{{$revOrder = "DESC"}}{{end}}

                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=guild&order={{if eq $currentSort "guild"}}{{$revOrder}}{{else}}ASC{{end}}{{$filter}}">{{.Page.T.guild}} {{if eq $currentSort "guild"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=members&order={{if eq $currentSort "members"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.members}} {{if eq $currentSort "members"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=kills&order={{if eq $currentSort "kills"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.total_kills}} {{if eq $currentSort "kills"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=deaths&order={{if eq $currentSort "deaths"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.total_deaths}} {{if eq $currentSort "deaths"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=kd&order={{if eq $currentSort "kd"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.kd_ratio}} {{if eq $currentSort "kd"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=damage&order={{if eq $currentSort "damage"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.total_damage}} {{if eq $currentSort "damage"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=healing&order={{if eq $currentSort "healing"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.total_healing}} {{if eq $currentSort "healing"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=emperium&order={{if eq $currentSort "emperium"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.emperium}} {{if eq $currentSort "emperium"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                            <th class="px-2 sm:px-3 py-2"><a href="/woe?sort_by=points&order={{if eq $currentSort "points"}}{{$revOrder}}{{else}}DESC{{end}}{{$filter}}">{{.Page.T.points}} {{if eq $currentSort "points"}}{{if eq $currentOrder "ASC"}}<span class="text-gray-400">▲</span>{{else}}<span class="text-gray-400">▼</span>{{end}}{{end}}</a></th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-xs">
                        {{range .Data.Guilds}}
                         <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="px-2 sm:px-3 py-2">
                                {{if .GuildName.Valid}}
                                <a href="/guild?name={{.GuildName.String | urlquery}}" class="font-semibold hover:underline">{{.GuildName.String}}</a>
                                {{else}}
                                <span class="text-gray-400">N/A</span>
                                {{end}}
                            </td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.MemberCount}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold text-green-600">{{.TotalKills | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold text-red-600">{{.TotalDeaths | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.KillDeathRatio | formatAvgLevel}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalDamage | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalHealing | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalEmpKills | formatZeny}}</td>
                            <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalPoints | formatZeny}}</td>
                        </tr>
                        {{else}}
                        <tr>
                            <td colspan="9" class="px-3 py-4 text-center text-gray-500">{{.Page.T.no_guilds_found}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                
                {{else if eq .Data.ActiveTab "guilds_by_class"}}
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            {{$filter := .Data.Filter}}
                            {{$currentSort := .Data.SortBy}}
                            {{$currentOrder := .Data.Order}}
                            {{$revOrder := "ASC"}}{{if eq $currentOrder "ASC"}}{{$revOrder = "DESC"}}{{end}}

                            <th class="px-2 sm:px-3 py-2">{{.Page.T.class}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.members}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.total_kills}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.total_deaths}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.kd_ratio}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.total_damage}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.total_healing}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.emperium}}</th>
                            <th class="px-2 sm:px-3 py-2">{{.Page.T.points}}</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-xs">
                        {{if .Data.GuildClassRanksMap}}
                            {{range $guildName, $classes := .Data.GuildClassRanksMap}}
                                <tr class="bg-gray-100 font-semibold border-b-2 border-gray-300">
                                    <td colspan="9" class="px-2 sm:px-3 py-2 text-sm">
                                        <a href="/guild?name={{$guildName | urlquery}}" class="hover:underline">{{$guildName}}</a>
                                    </td>
                                </tr>
                                {{range $class := $classes}}
                                <tr class="border-b border-gray-200 hover:bg-gray-50">
                                    <td class="px-2 sm:px-3 py-2 pl-6"> <div class="flex items-center">
                                            <img src="{{.Class | getClassImageURL}}" alt="{{.Class}}" class="w-6 h-6 mr-2" style="image-rendering: pixelated;">
                                            {{.Class}}
                                        </div>
                                    </td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.MemberCount}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold text-green-600">{{.TotalKills | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold text-red-600">{{.TotalDeaths | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.KillDeathRatio | formatAvgLevel}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalDamage | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalHealing | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalEmpKills | formatZeny}}</td>
                                    <td class="px-2 sm:px-3 py-2 font-semibold">{{.TotalPoints | formatZeny}}</td>
                                </tr>
                                {{end}}
                            {{end}}
                        {{else}}
                            <tr>
                                <td colspan="9" class="px-3 py-4 text-center text-gray-500">{{.Page.T.no_guilds_found}}</td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
                {{end}}

            </div>
        </div>
        
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const lang = document.documentElement.lang || 'en';
        const translations = {
            updated_never: '{{.Page.T.updated_never}}',
            updated_ago: '{{.Page.T.updated_ago}}'
        };

        const lastUpdateElement = document.getElementById('last-updated');
        if (lastUpdateElement) {
            const timestampStr = lastUpdateElement.dataset.timestamp;
            if (!timestampStr || timestampStr === 'Never' || timestampStr === '') {
                lastUpdateElement.textContent = translations.updated_never;
                return;
            }

            const lastUpdateDate = new Date(timestampStr);
            const formattedTimestamp = lastUpdateDate.toLocaleString([], {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            const updateTimeAgo = () => {
                const now = new Date();
                const secondsPast = Math.floor((now.getTime() - lastUpdateDate.getTime()) / 1000);
                let timeAgoString;
                
                if (lang === 'pt') {
                        if (secondsPast < 5) timeAgoString = 'agora mesmo';
                        else if (secondsPast < 60) timeAgoString = `${secondsPast}s`;
                        else if (secondsPast < 3600) timeAgoString = `${Math.floor(secondsPast / 60)}m`;
                        else if (secondsPast < 86400) timeAgoString = `${Math.floor(secondsPast / 3600)}h`;
                        else timeAgoString = `${Math.floor(secondsPast / 86400)}d`;
                } else {
                    if (secondsPast < 5) timeAgoString = 'just now';
                    else if (secondsPast < 60) timeAgoString = `${secondsPast}s ago`;
                    else if (secondsPast < 3600) timeAgoString = `${Math.floor(secondsPast / 60)}m ago`;
                    else if (secondsPast < 86400) timeAgoString = `${Math.floor(secondsPast / 3600)}h ago`;
                    else if (secondsPast < 86400) timeAgoString = `${Math.floor(secondsPast / 86400)}d ago`;
                }
                
                const fullString = translations.updated_ago.replace('%s', timeAgoString);
                lastUpdateElement.innerHTML = `${fullString} <span class="text-gray-400 font-normal">(${formattedTimestamp})</span>`;
            };
            updateTimeAgo();
            setInterval(updateTimeAgo, 30000);
        }
    });
    </script>
</body>
</html>
